
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<title>Dashboard FTP</title>
<style>
body{background:#f3f6fb;}
.topbar{background:#0d6efd;color:#fff;padding:14px;font-size:20px;font-weight:600;}
.card-stats{border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,0.08);padding:18px;}
.stat-number{font-size:30px;font-weight:700;}
.table-card{height:420px;overflow:auto;}
</style>
</head>
<body>

<div class="topbar">ğŸ“ VerificaciÃ³n FTP</div>

<div class="container mt-4">
<h2 class="text-center fw-bold">Panel de Monitoreo</h2>
<div class="text-center small text-muted">Ruta FTP: <span id="rutaFtp">-</span></div>

<div class="row g-3 mt-3">
  <div class="col-md-3"><div class="card-stats bg-white"><div>Total</div><div class="stat-number text-primary" id="total">0</div></div></div>
  <div class="col-md-3"><div class="card-stats bg-white"><div>Encontrados</div><div class="stat-number text-success" id="encontrados">0</div></div></div>
  <div class="col-md-3"><div class="card-stats bg-white"><div>Faltantes</div><div class="stat-number text-warning" id="faltantes">0</div></div></div>
  <div class="col-md-3"><div class="card-stats bg-white"><div>Avance</div><div class="stat-number text-info" id="porcentaje">0%</div></div></div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-7">
    <canvas id="donutChart" style="background:white;padding:20px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.08);"></canvas>
  </div>
  <div class="col-md-5">
    <div class="card bg-white p-3 table-card">
      <div class="d-flex justify-content-between mb-2">
        <h5 class="text-danger">Faltantes</h5>
        <button id="refreshBtn" class="btn btn-outline-primary btn-sm">ğŸ”„</button>
      </div>
      <table id="tablaFaltantes" class="table table-striped">
        <thead><tr><th>RENIPRES</th><th>Establecimiento</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="text-end small mt-3 text-muted">Actualizado: <span id="lastUpdate">-</span></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
let table;
let donut;

function renderDonut(a,b){
  const ctx=document.getElementById("donutChart");
  if(donut) donut.destroy();
  donut=new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["Encontrados","Faltantes"],
      datasets:[{data:[a,b],backgroundColor:["#198754","#f59e0b"],cutout:"70%"}]
    },
    options:{plugins:{legend:{display:false}}}
  });
}

function loadData(){
  $('#refreshBtn').text("...").prop("disabled",true);
  fetch("api")
  .then(r=>r.json())
  .then(d=>{
    $("#rutaFtp").text(d.ftp_folder);
    $("#total").text(d.total);
    $("#encontrados").text(d.encontrados);
    $("#faltantes").text(d.faltantes_count);
    $("#porcentaje").text(d.porcentaje+"%");
    $("#lastUpdate").text(d.timestamp);

    const tbody=$("#tablaFaltantes tbody").empty();
    d.faltantes.forEach(r=>{
      tbody.append(`<tr><td>${r.RENIPRES}</td><td>${r["ES"]||""}</td></tr>`);
    });

    if(!table){
      table=$("#tablaFaltantes").DataTable({pageLength:25});
    }else{
      table.clear().rows.add($("#tablaFaltantes tbody tr")).draw();
    }

    renderDonut(d.encontrados,d.faltantes_count);
  })
  .finally(()=>{
    $('#refreshBtn').text("ğŸ”„").prop("disabled",false);
  });
}

$("#refreshBtn").on("click",loadData);
$(document).ready(loadData);
</script>
</body>
</html>
